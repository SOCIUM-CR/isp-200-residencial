#!/usr/sbin/nft -f
# =============================================================================
# CGNAT - Carrier-Grade NAT Configuration (nftables)
# =============================================================================
# Pool interno: 100.64.0.0/16 (RFC 6598)
# Pool externo: 203.0.113.0/24 (bloque publico ISP)
# Ratio: ~8 usuarios por IP publica (8000 puertos cada uno)
# =============================================================================

flush ruleset

table ip nat {
    # Pool de IPs publicas para CGNAT
    # 203.0.113.2-203.0.113.30 = 29 IPs = ~232 usuarios (8 por IP)

    chain prerouting {
        type nat hook prerouting priority dstnat;
    }

    chain postrouting {
        type nat hook postrouting priority srcnat;

        # CGNAT: Trafico de suscriptores hacia Internet
        # Mapeo deterministico por rangos de IP

        # Sector A - 100.64.1.0/24 -> 203.0.113.2-203.0.113.5
        ip saddr 100.64.1.0/24 oifname "eth2" snat to 203.0.113.2-203.0.113.5

        # Sector A - 100.64.2.0/24 -> 203.0.113.6-203.0.113.9
        ip saddr 100.64.2.0/24 oifname "eth2" snat to 203.0.113.6-203.0.113.9

        # Sector B - 100.64.3.0/24 -> 203.0.113.10-203.0.113.13
        ip saddr 100.64.3.0/24 oifname "eth2" snat to 203.0.113.10-203.0.113.13

        # Sector B - 100.64.4.0/24 -> 203.0.113.14-203.0.113.17
        ip saddr 100.64.4.0/24 oifname "eth2" snat to 203.0.113.14-203.0.113.17

        # Sector C - 100.64.5.0/24 -> 203.0.113.18-203.0.113.21
        ip saddr 100.64.5.0/24 oifname "eth2" snat to 203.0.113.18-203.0.113.21

        # Sector C - 100.64.6.0/24 -> 203.0.113.22-203.0.113.25
        ip saddr 100.64.6.0/24 oifname "eth2" snat to 203.0.113.22-203.0.113.25
    }
}

table ip filter {
    chain input {
        type filter hook input priority filter;
        policy accept;
    }

    chain forward {
        type filter hook forward priority filter;
        policy accept;

        # Permitir trafico establecido
        ct state established,related accept

        # Permitir trafico desde suscriptores hacia Internet
        ip saddr 100.64.0.0/10 accept

        # Log de trafico denegado (opcional - para troubleshooting)
        # log prefix "CGNAT-DENY: " counter drop
    }

    chain output {
        type filter hook output priority filter;
        policy accept;
    }
}

# Tabla para logging de sesiones (cumplimiento legal)
table ip cgnat_log {
    chain log_sessions {
        type filter hook forward priority filter + 10;

        # Log nuevas conexiones (IP origen, puerto, IP destino)
        ct state new ip saddr 100.64.0.0/10 log prefix "CGNAT-SESSION: "
    }
}
